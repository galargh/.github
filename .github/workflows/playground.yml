name: Playground

on:
  workflow_dispatch:
  pull_request:
  push:
    paths: ['.github/workflows/playground.yml', '**/*.yml']
  release:
    types:
      - published
      - released

permissions:
  checks: write

defaults:
  run:
    shell: bash

jobs:
  playground:  
    runs-on: macos-13
    steps:
      - run: |
          release_tag_url="https://api.github.com/repos/filecoin-project/lotus/releases/tags/v1.32.2"
          release_name="lotus-Darwin-standard"
          
          release_response=$(curl -H "Authorization: token ${{ github.token }}" \
              --retry 3 \
              --location "${release_tag_url}")
          
          echo "release response:"
          echo "${release_response}"
          
          release_url=$(echo "${release_response}" | jq -r ".assets[] | select(.name | contains(\"${release_name}\")) | .url")
          
          echo "release url:"
          echo "${release_url}"
          
          tar_path="/tmp/${release_name}_$(basename "${release_url}").tar.gz"
          
          echo "tar path:"
          echo "${tar_path}"
          
          asset_url=$(curl -H "Authorization: token ${{ github.token }}" \
              --head \
              --retry 3 \
              --header "Accept:application/octet-stream" \
              --location \
              --output /dev/null \
              -w "%{url_effective}" \
              "${release_url}")
          
          echo "asset url:"
          echo "${asset_url}"
          
          curl -H "Authorization: token ${{ github.token }}" --retry 3 --output "${tar_path}" "${asset_url}"
          
          tar -xzf "${tar_path}"
