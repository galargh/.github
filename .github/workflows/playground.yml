name: Playground

on:
  workflow_dispatch:
  workflow_call:
  pull_request:
  push:
    paths: ['.github/workflows/playground.yml', '**/*.yml']
  release:
    types:
      - published
      - released

permissions:
  checks: write

defaults:
  run:
    shell: bash

env:
  ABC: 123

jobs:
  playground:
    runs-on: ubuntu-latest

    container:
      image: ubuntu:22.04

    services:
      dind:
        image: docker:dind
        options: --privileged

    steps:
      # 1. Install Docker Client and network utility
      - name: üõ†Ô∏è Install docker-ce-cli and curl
        run: |
          apt-get update
          apt-get install -y ca-certificates curl gnupg lsb-release

          install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          chmod a+r /etc/apt/keyrings/docker.gpg

          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
            tee /etc/apt/sources.list.d/docker.list > /dev/null

          apt-get update
          apt-get install -y docker-ce-cli curl

      # 2. Start the Nginx server
      - name: üöÄ Start Nginx server (via DIND)
        run: |
          # Run nginx on the default bridge network
          docker run -d \
            --name nginx-server \
            nginx:alpine

          sleep 2

          # Get nginx container's IP on the bridge network
          NGINX_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' nginx-server)
          echo "Nginx is running at $NGINX_IP:80"

          docker ps

          echo ""
          echo "=== Start socat forwarder to expose nginx on dind's external interface ==="
          # Run socat with host networking to forward traffic from 0.0.0.0:27018 to nginx's bridge IP
          docker run -d \
            --name port-forwarder \
            --network=host \
            alpine/socat \
            tcp-listen:27018,fork,reuseaddr,bind=0.0.0.0 tcp-connect:${NGINX_IP}:80

          sleep 3

          echo "Port forwarder started - forwarding 0.0.0.0:27018 -> ${NGINX_IP}:80"
          docker ps

      # 2.5. Debug connectivity and ports
      - name: üîç Debug connectivity
        run: |
          echo "=== Check what ports are published on nginx container ==="
          docker port nginx-server

          echo ""
          echo "=== Check nginx is working ==="
          docker exec nginx-server wget -q -O- http://localhost:80 && echo "‚úÖ Nginx is working inside its container"

          echo ""
          echo "=== Check what dind itself is listening on by running netstat from another container ==="
          docker run --rm --network=host alpine sh -c "apk add --no-cache netstat-nat && netstat -tlnp | grep 27018 || echo 'Port 27018 not found in netstat'"

          echo ""
          echo "=== Try to connect to port 27018 from within dind's network namespace ==="
          docker run --rm --network=host alpine sh -c "apk add --no-cache curl && curl -v --connect-timeout 3 http://localhost:27018 || echo 'Cannot connect to localhost:27018'"

      # 2.6. Check port binding on dind
      - name: üîç Check dind port binding
        run: |
          echo "=== Check if socat forwarder is running ==="
          docker ps -a | grep port-forwarder

          echo ""
          echo "=== Check socat logs ==="
          docker logs port-forwarder || echo "No logs available"

          echo ""
          echo "=== Verify socat can reach nginx from within dind ==="
          NGINX_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' nginx-server)
          echo "Nginx IP: $NGINX_IP"
          docker run --rm --network=host alpine sh -c "apk add --no-cache curl && curl -v --connect-timeout 3 http://$NGINX_IP:80"

          echo ""
          echo "=== Check what's listening on port 27018 inside dind ==="
          docker run --rm --network=host alpine sh -c "apk add --no-cache netstat && netstat -tlnp | grep 27018 || echo 'Nothing listening on 27018'"

          echo ""
          echo "=== Install required tools in main container ==="
          apt-get install -y netcat-openbsd

          echo ""
          echo "=== Check if anything is listening on 27018 from main container ==="
          nc -zv dind 27018 && echo "‚úÖ Port 27018 is open" || echo "‚ùå Port 27018 is closed"

      # 3. Test the server connection from main container
      - name: üì° Curl Nginx from main container
        run: |
          MAX_RETRIES=10
          DELAY=2
          URL=http://dind:27018

          echo "Attempting to connect to $URL..."

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES: Curling $URL..."

            # Curl from the main ubuntu container to the dind service
            curl -s --fail --connect-timeout 5 $URL

            if [ $? -eq 0 ]; then
              echo "‚úÖ Success: Received response from Nginx via $URL."
              exit 0 # Success, exit the script
            fi

            sleep $DELAY
          done

          echo "‚ùå Failure: Could not connect to the server after $MAX_RETRIES attempts."
          exit 1 # Failure, exit the job
