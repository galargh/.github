name: Playground

on:
  workflow_dispatch:
  workflow_call:
  pull_request:
  push:
    paths: ['.github/workflows/playground.yml', '**/*.yml']
  release:
    types:
      - published
      - released

permissions:
  checks: write

defaults:
  run:
    shell: bash

env:
  ABC: 123

jobs:
  playground:
    runs-on: ubuntu-latest

    container:
      image: ubuntu:22.04

    services:
      dind:
        image: docker:dind
        options: --privileged

    steps:
      # 1. Install Docker Client and network utility
      - name: üõ†Ô∏è Install docker-ce-cli and curl
        run: |
          apt-get update
          apt-get install -y ca-certificates curl gnupg lsb-release

          install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          chmod a+r /etc/apt/keyrings/docker.gpg

          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
            tee /etc/apt/sources.list.d/docker.list > /dev/null

          apt-get update
          apt-get install -y docker-ce-cli curl

      # 2. Start the Nginx server
      - name: üöÄ Start Nginx server (via DIND)
        run: |
          # Expose Nginx port 80 to DIND container's port 27018
          docker run -d \
            --name nginx-server \
            -p 27018:80 \
            nginx:alpine

          sleep 5

          docker ps

      # 2.5. Debug connectivity and ports
      - name: üîç Debug connectivity
        run: |
          echo "=== Installing debugging tools ==="
          apt-get install -y netcat-openbsd iputils-ping

          echo ""
          echo "=== Testing DNS resolution ==="
          getent hosts dind || echo "DNS resolution failed"

          echo ""
          echo "=== Ping test to dind ==="
          ping -c 3 dind || echo "Ping failed"

          echo ""
          echo "=== Check if port 27018 is open on dind ==="
          nc -zv dind 27018 || echo "Port 27018 is not open"

          echo ""
          echo "=== Get nginx container IP ==="
          NGINX_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' nginx-server)
          echo "Nginx IP: $NGINX_IP"

          echo ""
          echo "=== Try to curl nginx directly by IP ==="
          curl -v --connect-timeout 5 http://$NGINX_IP:80 || echo "Direct connection to nginx failed"

      # 3. Test the server connection from main container
      - name: üì° Curl Nginx from main container
        run: |
          MAX_RETRIES=10
          DELAY=2
          URL=http://dind:27018

          echo "Attempting to connect to $URL..."

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES: Curling $URL..."

            # Curl from the main ubuntu container to the dind service
            # nginx-server is on dind's internal bridge network (172.17.0.2)
            # dind service is on github_network (172.18.0.3) with port 27018 exposed
            curl -s --fail --connect-timeout 5 $URL

            if [ $? -eq 0 ]; then
              echo "‚úÖ Success: Received response from Nginx via $URL."
              exit 0 # Success, exit the script
            fi

            sleep $DELAY
          done

          echo "‚ùå Failure: Could not connect to the server after $MAX_RETRIES attempts."
          exit 1 # Failure, exit the job
