name: Playground

on:
  workflow_dispatch:
  workflow_call:
  pull_request:
  push:
    paths: ['.github/workflows/playground.yml', '**/*.yml']
  release:
    types:
      - published
      - released

permissions:
  checks: write

defaults:
  run:
    shell: bash

env:
  ABC: 123

jobs:
  playground:
    runs-on: ubuntu-latest

    container:
      image: debian:bookworm-slim

    services:
      dind:
        image: docker:dind
        options: --privileged

    steps:
      - name: Set up test env
        run: |
          set -e
          apt-get update && apt-get install -y lsb-release curl gpg

          # Add MongoDB repository
          curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg
          echo "deb [signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/debian $(lsb_release -cs)/mongodb-org/7.0 main" | tee -a /etc/apt/sources.list.d/mongodb-org-7.0.list

          # Add Docker repository
          curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          echo "deb [signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee -a /etc/apt/sources.list.d/docker.list

          apt-get update && apt-get install -y mongodb-org mongodb-atlas-cli docker-ce-cli

      - name: Start MongoDB
        run: |
          atlas config set silence_storage_warning true
          atlas deployments setup mongodb-atlas --type local --force

          sleep 3

          echo ""
          echo "=== Get github network name ==="
          GITHUB_NETWORK=$(docker network ls --filter "name=github_network" --port 27017 --format "{{.Name}}")
          echo "GitHub network: $GITHUB_NETWORK"

          echo ""
          echo "=== Connect mongodb-atlas to github network ==="
          docker network connect $GITHUB_NETWORK mongodb-atlas

          echo ""
          echo "=== Check mongodb-atlas network configuration ==="
          docker inspect mongodb-atlas --format='{{range $net,$v := .NetworkSettings.Networks}}{{printf "%s: %s\n" $net $v.IPAddress}}{{end}}'

          echo ""
          echo "=== Test from main container ==="
          apt-get install -y netcat-openbsd
          echo "Testing mongodb-atlas:27017 (MongoDB's internal port):"
          nc -zv mongodb-atlas 27017 && echo "✅ mongodb-atlas:27017 is accessible" || echo "❌ mongodb-atlas:27017 is NOT accessible"

      - name: mongodb-atlas:27017 is reachable
        run: |
          mongosh --host mongodb-atlas --port 27017 --eval 'db.runCommand({ ping: 1 })' --quiet

