name: Playground

on:
  workflow_dispatch:
  pull_request:
  push:
    paths: ['.github/workflows/playground.yml']

defaults:
  run:
    shell: bash

jobs:
  playground:
    runs-on: ubuntu-latest
    steps:
      - id: pr
        name: Retrieve PR information
        uses: actions/github-script@v6
        with:
          script: |
            let pr
            if (pr == null) {
              const {data: pulls} = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: 'protocol',
                repo: '.github-test-target',
                commit_sha: 'bd2a381ca1f8a6116632987d3f19138d40d30b36'
              });
              const open = pulls.filter(p => p.state == 'open');
              if (open.length == 0) {
                core.setFailed(`No open PR found for commit ${context.sha}`);
                return;
              }
              if (open.length > 1) {
                core.setFailed(`Multiple open PRs found for commit ${context.sha}`);
                return;
              }
              pr = open[0];
            }
            core.setOutput('json', JSON.stringify(pr));
      - env:
          PR: ${{ steps.pr.outputs.json }}
          RELEASE: ${{ contains(fromJSON(steps.pr.outputs.json).labels, 'release') }}
        run: echo Hello
