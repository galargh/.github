name: Playground

on:
  workflow_dispatch:
  workflow_call:
  pull_request:
  push:
    paths: ['.github/workflows/playground.yml', '**/*.yml']
  release:
    types:
      - published
      - released

permissions:
  checks: write

defaults:
  run:
    shell: bash

env:
  ABC: 123

jobs:
  playground:
    runs-on: ubuntu-latest

    container:
      image: debian:bookworm-slim

    services:
      dind:
        image: docker:dind
        options: --privileged

    steps:
      - name: Set up test env
        run: |
          set -e
          apt-get update && apt-get install -y lsb-release curl gpg

          # Add MongoDB repository
          curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg
          echo "deb [signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/debian $(lsb_release -cs)/mongodb-org/7.0 main" | tee -a /etc/apt/sources.list.d/mongodb-org-7.0.list

          # Add Docker repository
          curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          echo "deb [signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee -a /etc/apt/sources.list.d/docker.list

          apt-get update && apt-get install -y mongodb-org mongodb-atlas-cli docker-ce-cli

      - name: Start MongoDB
        run: |
          atlas config set silence_storage_warning true
          atlas deployments setup mongodb-atlas --type local --port 27018 --force

          echo ""
          echo "=== Setup socat forwarder on port 27019 ==="
          # MongoDB binds to 127.0.0.1:27018 inside dind
          # We'll use socat to forward from 0.0.0.0:27019 -> 127.0.0.1:27018
          # Note: Without specifying bind, socat listens on all interfaces (0.0.0.0)
          docker run -d --name mongodb-atlas-proxy --network host alpine/socat TCP-LISTEN:27019,fork,reuseaddr TCP:127.0.0.1:27018

          sleep 3

          echo ""
          echo "=== Debug: Check containers ==="
          docker ps -a

          echo ""
          echo "=== Debug: Check socat logs ==="
          docker logs mongodb-atlas-proxy

          echo ""
          echo "=== Debug: What's listening on port 27019 inside dind? ==="
          docker run --rm --network=host alpine sh -c "apk add --no-cache netstat-nat && netstat -tlnp | grep 27019 || echo 'Nothing on 27019'"

          echo ""
          echo "=== Debug: Check all listening ports ==="
          docker run --rm --network=host alpine sh -c "apk add --no-cache netstat-nat && netstat -tlnp"

          echo ""
          echo "=== Debug: Test localhost:27019 from within dind ==="
          docker run --rm --network=host alpine sh -c "apk add --no-cache netcat-openbsd && nc -zv localhost 27019 && echo '✅ Port 27019 works on localhost inside dind' || echo '❌ Port 27019 not accessible on localhost inside dind'"

          echo ""
          echo "=== Debug: Test localhost:27018 from within dind ==="
          docker run --rm --network=host alpine sh -c "apk add --no-cache netcat-openbsd && nc -zv localhost 27018 && echo '✅ Port 27018 works on localhost inside dind' || echo '❌ Port 27018 not accessible on localhost inside dind'"

          echo ""
          echo "=== Debug: Check network interfaces inside dind ==="
          docker run --rm --network=host alpine sh -c "ip addr show"

          echo ""
          echo "=== Debug: Test from main container ==="
          apt-get install -y netcat-openbsd
          echo "Testing port 27018 (direct MongoDB, should fail):"
          nc -zv dind 27018 && echo "✅ Port 27018 is accessible" || echo "❌ Port 27018 is NOT accessible (expected)"
          echo "Testing port 27019 (socat proxy, should work):"
          nc -zv dind 27019 && echo "✅ Port 27019 is accessible" || echo "❌ Port 27019 is NOT accessible"

      - name: localhost:27019 is reachable
        continue-on-error: true
        run: |
          mongosh --host localhost --port 27019 --eval 'db.runCommand({ ping: 1 })' --quiet 2>/dev/null

      - name: 0.0.0.0:27019 is reachable
        continue-on-error: true
        run: |
          mongosh --host 0.0.0.0 --port 27019 --eval 'db.runCommand({ ping: 1 })' --quiet 2>/dev/null

      - name: 127.0.0.1:27019 is reachable
        continue-on-error: true
        run: |
          mongosh --host 127.0.0.1 --port 27019 --eval 'db.runCommand({ ping: 1 })' --quiet 2>/dev/null

      - name: dind:27019 is reachable
        continue-on-error: true
        run: |
          mongosh --host dind --port 27019 --eval 'db.runCommand({ ping: 1 })' --quiet 2>/dev/null

      - name: mongodb-atlas:27019 is reachable
        continue-on-error: true
        run: |
          mongosh --host mongodb-atlas --port 27019 --eval 'db.runCommand({ ping: 1 })' --quiet 2>/dev/null

      - name: mongodb-atlas-proxy:27019 is reachable
        continue-on-error: true
        run: |
          mongosh --host mongodb-atlas-proxy --port 27019 --eval 'db.runCommand({ ping: 1 })' --quiet 2>/dev/null

      - name: host.docker.internal:27019 is reachable
        continue-on-error: true
        run: |
          mongosh --host host.docker.internal --port 27019 --eval 'db.runCommand({ ping: 1 })' --quiet 2>/dev/null

